{"version":3,"file":"TerrainMB.js","sourceRoot":"","sources":["../src/TerrainMB.ts"],"names":[],"mappings":"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","sourcesContent":["import { Scene } from \"@babylonjs/core/scene\";\r\nimport { Vector2 } from \"@babylonjs/core/Maths/math\";\r\nimport { Vector3 } from \"@babylonjs/core/Maths/math\";\r\nimport { Texture } from '@babylonjs/core/Materials/Textures/texture';\r\nimport { FloatArray, Observable, ThinEngine, VertexBuffer } from \"@babylonjs/core\";\r\nimport Tile from './Tile';\r\nimport TileSet from \"./TileSet\";\r\n\r\n//import \"@babylonjs/core/Materials/standardMaterial\"\r\n//import \"@babylonjs/inspector\";\r\n\r\nexport default class TerrainMB {\r\n    private mbServer: string = \"https://api.mapbox.com/v4/\";\r\n\r\n    public globalMinHeight = Number.POSITIVE_INFINITY;\r\n    private index = 0;\r\n    public accessToken: string = \"\";\r\n    private heightScaleFixer=0;\r\n    private skuToken: string=\"\";\r\n    //public onAllLoaded: Observable<boolean> = new Observable();\r\n\r\n    constructor(public tileSet: TileSet, private scene: Scene) {\r\n        if(this.tileSet){\r\n            if(this.tileSet.ourTileMath){\r\n                console.log(\"we seem to be able to access tileMath here\");\r\n\r\n            } else{\r\n                console.error(\"unable to access tileMath!\");\r\n            }\r\n        } else{\r\n            console.error(\"unable to access tileSet!\");\r\n        }  \r\n        this.skuToken = this.tileSet.ourTileMath.generateSKU();\r\n          \r\n    }  \r\n\r\n    public setExaggeration(tileScale: number, exaggeration: number) {\r\n        this.heightScaleFixer = tileScale * exaggeration;\r\n    }\r\n\r\n    //based on code from\r\n    //https://www.babylonjs-playground.com/#DXARSP#30\r\n    private GetAsyncTexture (url: string) : Promise<Texture> {\r\n        return new Promise((resolve, reject) => {\r\n            var texture = new Texture(url, this.scene, true, false, Texture.NEAREST_SAMPLINGMODE, function() {\r\n                console.log(\"loading texture success!\");\r\n                resolve(texture);\r\n            }, function(message) {\r\n                reject(message);\r\n            });    \r\n        })\r\n    }\r\n\r\n    public updateAllTerrainTiles(exaggeration: number) {\r\n        this.setExaggeration(this.tileSet.ourTileMath.computeTileScale(), exaggeration);\r\n\r\n        for (let t of this.tileSet.ourTiles) {\r\n            this.updateSingleTerrainTile(t);         \r\n        }\r\n\r\n        //Fix Seams Here\r\n        /*for (let t of this.ourTiles) {\r\n            for (let t2 of this.ourTiles) {\r\n                if ((t.tileCoords.x == (t2.tileCoords.x - 1)) && (t.tileCoords.y == t2.tileCoords.y)) {\r\n                    if (t.eastSeamFixed == false) {\r\n                        this.ourMB.fixEastSeam(t,t2);\r\n                    }\r\n                }\r\n                if ((t.tileCoords.x == t2.tileCoords.x) && (t.tileCoords.y == (t2.tileCoords.y+1))) {\r\n                    if (t.northSeamFixed == false) {\r\n                        this.ourMB.fixNorthSeam(t,t2);\r\n                    }\r\n                }\r\n                if ((t.tileCoords.x == (t2.tileCoords.x - 1)) && (t.tileCoords.y == (t2.tileCoords.y+1))) {\r\n                    if (t.northEastSeamFixed == false) {\r\n                        this.ourMB.fixNorthEastSeam(t,t2);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        */\r\n        //this.ourMB.getTileTerrain(this.ourTiles[0]); //just one for testing\r\n    }\r\n\r\n    /*public setupTerrainLOD(precisions: number[], distances:number[]) {\r\n        for (let t of this.ourTiles) {\r\n\r\n            for (let i = 0; i < precisions.length; i++) {\r\n                const precision = precisions[i];\r\n                const distance = distances[i];\r\n\r\n                if(precision>0){\r\n                    const loadMesh = this.makeSingleTileMesh(t.colRow.x, t.colRow.y, precision);\r\n                    this.ourMB.applyHeightArrayToMesh(loadMesh, t, precision, -this.globalMinHeight);\r\n                    loadMesh.material = t.material;\r\n                    t.mesh.addLODLevel(distance, loadMesh);\r\n                }\r\n                else{\r\n                    t.mesh.addLODLevel(distance,null);\r\n                }\r\n            }\r\n        }\r\n    }*/\r\n\r\n\r\n    //https://docs.mapbox.com/data/tilesets/reference/mapbox-terrain-dem-v1/\r\n    public async updateSingleTerrainTile(tile: Tile) {\r\n        tile.terrainLoaded=false;\r\n\r\n        if(tile.tileCoords.z>15 && this.tileSet.doTerrainResBoost==false){            \r\n            console.log(\"DEM not supported beyond level 15 (if not doing res boost)\");\r\n            return;\r\n        }\r\n        if(tile.tileCoords.z>14 && this.tileSet.doTerrainResBoost==true){            \r\n            console.log(\"DEM not supported beyond 14 (if doing res boost)\");\r\n            return;\r\n        }\r\n\r\n        const storedCoords=tile.tileCoords.clone();\r\n\r\n        tile.dem = []; //to reclaim memory?\r\n\r\n        const prefix = this.mbServer;\r\n        const boostParam = this.tileSet.doTerrainResBoost ? \"@2x\" : \"\";\r\n\r\n        //const mapType = \"mapbox.terrain-rgb\";\r\n        const mapType = \"mapbox.mapbox-terrain-dem-v1\";\r\n\r\n        const extension = \".pngraw\";\r\n        const skuParam = \"?sku=\" + this.skuToken;\r\n        const accessParam = \"&access_token=\" + this.accessToken;\r\n        const url = prefix + mapType + \"/\" + (tile.tileCoords.z) + \"/\" + (tile.tileCoords.x) + \"/\" + (tile.tileCoords.y) + boostParam + extension + skuParam + accessParam;\r\n\r\n        console.log(\"trying to get: \" + url);\r\n       \r\n        const ourTex: Texture = await this.GetAsyncTexture(url); //wait for loading to be complete\r\n\r\n        if (!ourTex){\r\n            console.error(\"unable to load terrain for: \" + tile.tileCoords);\r\n            return;\r\n        }\r\n        //console.log(\"terrain dimensions: \" + tile.demDimensions);\r\n\r\n        const bufferView = await ourTex.readPixels();\r\n\r\n        if (!bufferView) {\r\n            console.error(\"unable to read pixels from texture for terrain tile: \" + tile.tileCoords);\r\n        }\r\n\r\n        const buffer: ArrayBuffer = bufferView!.buffer;\r\n        const bufferUint: Uint8Array = new Uint8Array(buffer);\r\n        //console.log(\"terrain buffer dimensions: \" + bufferUint.byteLength)\r\n\r\n        if(tile.tileCoords.equals(storedCoords)==false){\r\n            console.warn(\"looks like tile coords have changed already! bailing on this update for: \" + tile.tileCoords);\r\n            return;\r\n        }\r\n\r\n        tile.demDimensions = new Vector2(ourTex.getSize().width, ourTex.getSize().height);\r\n\r\n        this.convertRGBtoDEM(bufferUint, tile);\r\n        this.applyDEMToMesh(tile, this.tileSet.meshPrecision);\r\n\r\n        tile.terrainLoaded=true;\r\n\r\n        this.fixTileSeams();\r\n\r\n        /*\r\n        for(let t of this.tileSet.ourTiles){\r\n            if(!t.terrainLoaded){\r\n                return;\r\n            }\r\n        }\r\n\r\n        this.onAllLoaded.notifyObservers(true);  */\r\n    }\r\n\r\n    private fixTileSeams() {\r\n        for (let t of this.tileSet.ourTiles) {\r\n            if(!t.terrainLoaded){               \r\n                continue;\r\n            }\r\n\r\n            if (!t.northSeamFixed) {\r\n                //console.log(\"tile doesn't have north seam fixed yet: \" + t.tileCoords);\r\n                const upperTileCoords = t.tileCoords.clone();\r\n                upperTileCoords.y--;\r\n\r\n                const upperTileCoordsString = upperTileCoords.toString();\r\n\r\n                const upperTile = this.tileSet.ourTilesMap.get(upperTileCoordsString);\r\n                if (upperTile) {\r\n                    console.log(\"found upper tile for tile: \" + t.tileCoords);\r\n                    if (upperTile.terrainLoaded) {\r\n                        this.fixNorthSeam(t, upperTile);\r\n                    }\r\n                }\r\n            }\r\n            if (!t.eastSeamFixed) {\r\n                //console.log(\"tile doesn't have east seam fixed yet: \" + t.tileCoords);\r\n                const rightTileCoords = t.tileCoords.clone();\r\n                rightTileCoords.x++;\r\n\r\n                const rightTileCoordsString = rightTileCoords.toString();\r\n\r\n                const rightTile = this.tileSet.ourTilesMap.get(rightTileCoordsString);\r\n                if (rightTile) {\r\n                    console.log(\"found right tile for tile: \" + t.tileCoords);\r\n                    if (rightTile.terrainLoaded) {\r\n                        this.fixEastSeam(t, rightTile);\r\n                    }\r\n                }\r\n            }\r\n            if (!t.northEastSeamFixed) {\r\n                //console.log(\"tile doesn't have east seam fixed yet: \" + t.tileCoords);\r\n                const upperRightCoords = t.tileCoords.clone();\r\n                upperRightCoords.x++;\r\n                upperRightCoords.y--;\r\n\r\n                const upperRightCoordsString = upperRightCoords.toString();\r\n\r\n                const upperRightTile = this.tileSet.ourTilesMap.get(upperRightCoordsString);\r\n                if (upperRightTile) {\r\n                    console.log(\"found upper right tile for tile: \" + t.tileCoords);\r\n                    if (upperRightTile.terrainLoaded) {\r\n                        this.fixNorthEastSeam(t, upperRightTile);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    //https://docs.mapbox.com/data/tilesets/guides/access-elevation-data/\r\n    private convertRGBtoDEM(ourBuff: Uint8Array, tile: Tile) {\r\n        var heightDEM: number[] = [];\r\n        let maxHeight = Number.NEGATIVE_INFINITY;\r\n        let minHeight = Number.POSITIVE_INFINITY;      \r\n\r\n        for (let i = 0; i < ourBuff.length; i += 4) {\r\n            //documentation: height = -10000 + ((R * 256 * 256 + G * 256 + B) * 0.1)\r\n\r\n            const R = ourBuff[i + 0];\r\n            const G = ourBuff[i + 1];\r\n            const B = ourBuff[i + 2];\r\n            //const A = image[i + 3]; //unused\r\n\r\n            const height = -10000.0 + ((R * 256.0 * 256.0 + G * 256.0 + B) * 0.1);\r\n            if (height > maxHeight) {\r\n                maxHeight = height;\r\n            }\r\n            if (height < minHeight) {\r\n                minHeight = height;\r\n            }\r\n\r\n            heightDEM.push(height);\r\n        }\r\n        console.log(\"  terrain ranges from : \" + minHeight.toFixed(2) + \" to \" + maxHeight.toFixed(2));\r\n        console.log(\"  height delta: \" + (maxHeight - minHeight).toFixed(2));\r\n\r\n        tile.dem = heightDEM;\r\n        tile.minHeight = minHeight;\r\n        tile.maxHeight = maxHeight;\r\n\r\n        if(tile.minHeight<this.globalMinHeight){\r\n            this.globalMinHeight=tile.minHeight;\r\n        }\r\n    }\r\n\r\n    public applyDEMToMesh(tile: Tile, meshPrecision: number) {\r\n        const positions = tile.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const subdivisions = meshPrecision + 1;\r\n\r\n        for (let y = 0; y < subdivisions; y++) {\r\n            for (let x = 0; x < subdivisions; x++) {\r\n                const percent = new Vector2(x / (subdivisions - 1), y / (subdivisions - 1));\r\n                const demIndex = this.computeIndexByPercent(percent, tile.demDimensions);                \r\n                const height = (tile.dem[demIndex]) * this.heightScaleFixer;\r\n                const meshIndex = 1 + (x + y * subdivisions) * 3;\r\n\r\n                positions[meshIndex] = height;\r\n            }\r\n        }\r\n\r\n        tile.mesh.updateVerticesData(VertexBuffer.PositionKind, positions);\r\n        tile.mesh.refreshBoundingInfo();\r\n    }\r\n\r\n    private computeIndexByPercent(percent: Vector2, maxPixel: Vector2): number {\r\n        const pixelX = Math.floor(percent.x * (maxPixel.x - 1));\r\n        const pixelY = Math.floor(percent.y * (maxPixel.y - 1));\r\n\r\n        const total = pixelY * maxPixel.x + pixelX;\r\n        //console.log(\"Percent: \" + percent.x + \" \" + percent.y + \" Pixel: \"+ pixelX + \" \" + pixelY + \" Total: \" + total);\r\n\r\n        return total;\r\n    }\r\n\r\n    public fixNorthSeam(tile: Tile, tileUpper: Tile) {\r\n        const positions1 = tile.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const positions2 = tileUpper.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const subdivisions = this.tileSet.meshPrecision + 1;\r\n\r\n        const y1 = 0;\r\n        const y2 = subdivisions - 1;\r\n\r\n        let xStop = subdivisions;\r\n        if (tile.northEastSeamFixed) {\r\n            xStop--; //skip corner\r\n        }\r\n\r\n        for (let x = 0; x < xStop; x++) {\r\n            const meshIndex1 = 1 + (x + y1 * subdivisions) * 3;\r\n            const meshIndex2 = 1 + (x + y2 * subdivisions) * 3;\r\n\r\n            positions1[meshIndex1] = positions2[meshIndex2];\r\n        }\r\n\r\n        tile.mesh.updateVerticesData(VertexBuffer.PositionKind, positions1);\r\n        tile.mesh.refreshBoundingInfo();\r\n        tile.northSeamFixed = true;\r\n    }\r\n\r\n    public fixEastSeam(tile: Tile, tileRight: Tile) {\r\n        const positions1 = tile.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const positions2 = tileRight.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const subdivisions = this.tileSet.meshPrecision + 1;\r\n\r\n        const x1 = subdivisions - 1;\r\n        const x2 = 0;\r\n\r\n        let yStart = 0;\r\n        if (tile.northEastSeamFixed) {\r\n            yStart++; //skip corner\r\n        }\r\n\r\n        for (let y = yStart; y < subdivisions; y++) {\r\n\r\n            const meshIndex1 = 1 + (x1 + y * subdivisions) * 3;\r\n            const meshIndex2 = 1 + (x2 + y * subdivisions) * 3;\r\n\r\n            positions1[meshIndex1] = positions2[meshIndex2];\r\n        }\r\n\r\n        tile.mesh.updateVerticesData(VertexBuffer.PositionKind, positions1);\r\n        tile.mesh.refreshBoundingInfo();\r\n        tile.eastSeamFixed = true;\r\n    }\r\n\r\n    public fixNorthEastSeam(tile: Tile, tileUpperRight: Tile) {\r\n        const positions1 = tile.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const positions2 = tileUpperRight.mesh.getVerticesData(VertexBuffer.PositionKind) as FloatArray;\r\n        const subdivisions = this.tileSet.meshPrecision + 1;\r\n\r\n        const x1 = subdivisions - 1;\r\n        const x2 = 0;\r\n\r\n        const y1 = 0;\r\n        const y2 = subdivisions - 1;\r\n\r\n        const meshIndex1 = 1 + (x1 + y1 * subdivisions) * 3;\r\n        const meshIndex2 = 1 + (x2 + y2 * subdivisions) * 3;\r\n\r\n        positions1[meshIndex1] = positions2[meshIndex2];\r\n\r\n        tile.mesh.updateVerticesData(VertexBuffer.PositionKind, positions1);\r\n        tile.mesh.refreshBoundingInfo();\r\n        tile.northEastSeamFixed = true;\r\n    }\r\n    \r\n    /*\r\n    //DEM Version of seam fixing\r\n    public fixNorthSeam(tile: Tile, tileUpper: Tile){\r\n        const dem1=tile.dem;\r\n        const dem2=tileUpper.dem;\r\n        const dimensions=tile.demDimensions;\r\n\r\n        for(let x=0; x<dimensions.x;x++){\r\n            const pos1Index=x;\r\n            const pos2Index=x+dimensions.x*(dimensions.y-1); //last row\r\n\r\n            const height1=dem1[pos1Index];\r\n            const height2=dem2[pos2Index];\r\n\r\n            dem1[pos1Index]=height2;\r\n        }      \r\n\r\n        tile.northSeamFixed = true;\r\n    }\r\n\r\n    //DEM Version of seam fixing\r\n    public fixEastSeam(tile: Tile, tileRight: Tile) {\r\n        //console.log(\"fixing right seam!\");\r\n        //console.log(\"dem size: \"+ tile.dem.length);\r\n        const dem1 = tile.dem;\r\n        const dem2 = tileRight.dem;\r\n        const dimensions = tile.demDimensions;\r\n        //console.log(\"dem dimensions: \" + dimensions.x + \" \" + dimensions.y);\r\n\r\n        for (let y = 0; y < dimensions.y; y++) {\r\n            const pos1Index = (dimensions.x - 1) + y * dimensions.x; //right most col\r\n            const pos2Index = y * dimensions.x; //left most col\r\n\r\n            const height1=dem1[pos1Index];\r\n            const height2 = dem2[pos2Index];\r\n\r\n            dem1[pos1Index]=height2;\r\n        }       \r\n\r\n        tile.eastSeamFixed = true;\r\n    }\r\n    \r\n    //DEM Version of seam fixing\r\n    public fixNorthEastSeam(tile: Tile, tileUpperRight: Tile) {\r\n\r\n        //console.log(\"dem size: \"+ tile.dem.length);\r\n        const dem1 = tile.dem;\r\n        const dem2 = tileUpperRight.dem;\r\n        const dimensions = tile.demDimensions;\r\n\r\n        const pos1Index = (dimensions.x - 1); //upper right\r\n        const pos2Index = (dimensions.y - 1) * dimensions.x; //lower left\r\n\r\n        const height1 = dem1[pos1Index];\r\n        const height2 = dem2[pos2Index];\r\n\r\n        dem1[pos1Index] = height2;\r\n    \r\n        tile.northEastSeamFixed = true;\r\n    }\r\n    */\r\n}"]}