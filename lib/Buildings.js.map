{"version":3,"file":"Buildings.js","sourceRoot":"","sources":["../src/Buildings.ts"],"names":[],"mappings":"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","sourcesContent":["import { Scene } from \"@babylonjs/core/scene\";\nimport { Vector3 } from \"@babylonjs/core/Maths/math\";\nimport { Color3 } from \"@babylonjs/core/Maths/math\";\nimport { Mesh } from \"@babylonjs/core/Meshes/mesh\";\nimport { StandardMaterial } from '@babylonjs/core/Materials/standardMaterial';\n\nimport * as GeoJSON from './GeoJSON';\nimport Tile from \"./Tile\";\nimport TileSet from \"./TileSet\";\nimport { EPSG_Type } from \"./TileMath\";\nimport { Observable } from \"@babylonjs/core\";\n\n\n//import \"@babylonjs/core/Materials/standardMaterial\"\n//import \"@babylonjs/inspector\";\n\nexport enum BuildingRequestType {\n    LoadTile,\n    CreateBuilding,\n    MergeAllBuildingsOnTile\n}\n\nexport enum RetrievalType {\n    IndividualTiles,\n    AllData\n}\n\nexport interface BuildingRequest {\n    requestType: BuildingRequestType;\n    tile: Tile;\n    tileCoords: Vector3;\n    inProgress: boolean;\n    flipWinding: boolean;\n    feature?: GeoJSON.feature;\n    epsgType?: EPSG_Type;\n    url?: string;\n}\n\ninterface GeoFileLoaded {\n    url: string;\n    topLevel: GeoJSON.topLevel;\n}\n\nexport default abstract class Buildings {\n\n    //things the user might be interested in changing\n    public exaggeration = 1.0;\n    public doMerge = false;\n    public defaultBuildingHeight = 4.0;\n    public lineWidth = 0.0001; //TODO: this needs to be different for EPSG:4326 vs EPSG:3857\n    public pointDiameter = 0.5; //TODO: this is currently in game world units\n    public buildingsCreatedPerFrame = 10; //TODO: is there a better way to do this?\n    public cacheFiles = true;\n    public buildingMaterial: StandardMaterial;\n    public retrievalType: RetrievalType = RetrievalType.IndividualTiles;\n\n    protected buildingRequests: BuildingRequest[] = [];\n    protected filesLoaded: GeoFileLoaded[] = [];\n\n    private requestsProcessedSinceCaughtUp = 0;\n    protected ourGeoJSON: GeoJSON.GeoJSON;\n    private scene: Scene;\n    public onCaughtUpObservable: Observable<boolean> = new Observable;\n\n    private sleepRequested = false;\n    private timeStart: number;\n    private sleepDuration=5000; //5 seconds\n\n    constructor(public name: string, protected tileSet: TileSet) {\n        this.scene = this.tileSet.scene;\n\n        this.buildingMaterial = new StandardMaterial(\"buildingMaterial\", this.scene);\n        this.buildingMaterial.diffuseColor = new Color3(0.8, 0.8, 0.8);\n        this.buildingMaterial.freeze();\n        this.ourGeoJSON = new GeoJSON.GeoJSON(tileSet, this.scene);\n\n        const observer = this.scene.onBeforeRenderObservable.add(() => { //fire every frame\n            this.processBuildingRequests();\n        });\n    }\n\n    public abstract SubmitLoadTileRequest(tile: Tile): void;\n    public abstract SubmitLoadAllRequest(): void;\n\n    public ProcessGeoJSON(request: BuildingRequest, topLevel: GeoJSON.topLevel): void {\n        if (request.tile.tileCoords.equals(request.tileCoords) == false) {\n            console.warn(this.prettyName() + \"tile coords have changed while we were loading, not adding buildings to queue!\");\n            return;\n        }\n\n        let index = 0;\n        let addedBuildings = 0;\n        const meshArray: Mesh[] = [];\n        for (const f of topLevel.features) {\n            const brequest: BuildingRequest = {\n                requestType: BuildingRequestType.CreateBuilding,\n                tile: request.tile,\n                tileCoords: request.tile.tileCoords.clone(),\n                inProgress: false,\n                epsgType: request.epsgType,\n                feature: f,\n                flipWinding: request.flipWinding\n            }\n            this.buildingRequests.push(brequest);\n            addedBuildings++;\n        }\n\n        if (this.doMerge) {\n            //console.log(\"queueing up merge request for tile: \" + tile.tileCoords);\n            const mrequest: BuildingRequest = {\n                requestType: BuildingRequestType.MergeAllBuildingsOnTile, //request a merge\n                tile: request.tile,\n                tileCoords: request.tile.tileCoords.clone(),\n                inProgress: false,\n                flipWinding: request.flipWinding\n            }\n            this.buildingRequests.push(mrequest)\n        }\n        console.log(this.prettyName() + addedBuildings + \" building generation requests queued for tile: \" + request.tile.tileCoords);\n    }\n\n    protected prettyName(): string {\n        return \"[Buildings \" + this.name + \"] \";\n    }\n\n    private isURLLoaded(url: string): boolean {\n        const stripped = this.stripFilePrefix(url);\n        for (let f of this.filesLoaded) {\n            if (f.url == stripped) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    private getFeatures(url: string): GeoJSON.topLevel | null {\n        const stripped = this.stripFilePrefix(url);\n        for (let f of this.filesLoaded) {\n            if (f.url == stripped) {\n                return f.topLevel;\n            }\n        }\n\n        return null;\n    }\n\n    protected stripFilePrefix(original: string): string {\n        return original;\n    }\n\n    protected removePendingRequest(index = 0) {\n        //console.log(this.prettyName() + \"popping request off front of queue\");\n        this.requestsProcessedSinceCaughtUp++;\n\n        //this.buildingRequests.shift(); //pop ourselves off the queue\n        this.buildingRequests.splice(index, 1);\n    }\n\n    protected handleLoadTileRequest(request: BuildingRequest): void {\n        if (!request.url) {\n            console.error(this.prettyName() + \"no valid URL specified in GeoJSON load request\");\n\n            this.removePendingRequest();\n            return;\n        }\n\n        if (this.isURLLoaded(request.url)) { //is the file already cached?\n            console.log(this.prettyName() + \"we already have this GeoJSON loaded: \" + this.stripFilePrefix(request.url));\n            const topLevel = this.getFeatures(request.url);\n            if (topLevel) {\n                this.ProcessGeoJSON(request, topLevel);\n            } else {\n                console.error(this.prettyName() + \"can't find topLevel in already loaded geojson file!\");\n            }\n\n            this.removePendingRequest();\n            return;\n        }\n\n        console.log(this.prettyName() + \"trying to fetch: \" + request.url);\n        request.inProgress = true;\n\n        fetch(request.url).then((res) => {\n            if (res.status == 200) {\n                res.text().then(\n                    (text) => {\n                        console.log(this.prettyName() + \"fetch completed for buildings for tile: \" + request.tileCoords);\n\n                        if (text.length > 0) {\n                            //console.log(this.prettyName() + \"about to json parse for tile: \" + request.tileCoords);\n\n                            const topLevel: GeoJSON.topLevel = JSON.parse(text);\n\n                            if (this.cacheFiles) {\n                                const floaded: GeoFileLoaded = {\n                                    url: this.stripFilePrefix(request.url!),\n                                    topLevel: topLevel\n                                };\n                                this.filesLoaded.push(floaded);\n                            }\n\n                            this.ProcessGeoJSON(request, topLevel);\n                        }\n\n                        this.removePendingRequest();\n                        return;\n                    }\n                );\n            } else if (res.status == 500) {\n                console.log(\"Error 500 requesting: \" + request.url);\n\n                console.log(\"but we will try again!\");\n                this.buildingRequests.push(request); //let's try again? maybe there should be a maximum number of retries?\n                this.timeStart=Date.now();\n                this.sleepRequested=true;\n                this.removePendingRequest(); //remove original request\n                return;\n            }\n            else {\n                console.error(this.prettyName() + \"unable to fetch: \" + request.url + \" error code: \" + res.status);\n                this.removePendingRequest();\n                return;\n            }\n        }\n        ).catch((error) => {\n            console.error(this.prettyName() + \"error during fetch! \" + error);\n\n            this.removePendingRequest();\n            return;\n        });\n\n        return;\n    }\n\n    public processBuildingRequests() {\n        if (this.sleepRequested) { //lets take a nap for a bit (when we get a 500 server error)\n            const timeDiff=Date.now()-this.timeStart;\n            console.log(\"we've slept for: \" + timeDiff);\n            \n            if(timeDiff>this.sleepDuration){\n                console.log(\"done sleeping after: \" + timeDiff);\n                this.sleepRequested=false;\n            }\n        }\n\n        if (this.buildingRequests.length == 0) {\n            if (this.requestsProcessedSinceCaughtUp > 0) {\n                console.log(this.prettyName() + \"caught up on all building generation requests! (processed \" + this.requestsProcessedSinceCaughtUp + \" requests)\");\n                this.requestsProcessedSinceCaughtUp = 0;\n                this.onCaughtUpObservable.notifyObservers(true);\n            }\n            return;\n        }\n\n        for (let i = 0; i < this.buildingsCreatedPerFrame; i++) { //process certain number of requests per frame\n            //console.log(\"requests remaining in queue: \" + this.buildingRequests.length);\n            if (this.buildingRequests.length == 0) {\n                return;\n            }\n            let rIndex = 0;\n            let request = this.buildingRequests[rIndex]; //peek at front of queue\n\n            let foundWork = false;\n            if (request.inProgress == true) {\n\n                //TODO: this is where we could do some work while waiting (maybe process some buildings?)\n                for (let e = 1; e < this.buildingRequests.length; e++) {\n                    request = this.buildingRequests[e];\n                    if (request.requestType == BuildingRequestType.CreateBuilding || request.requestType == BuildingRequestType.MergeAllBuildingsOnTile) {\n                        console.log(this.prettyName() + \"found some work to do while waiting!\");\n                        foundWork = true;\n                        rIndex = e;\n                        break;\n                    }\n                }\n                if (foundWork == false) {\n                    return; //nothing to do\n                }\n            }\n\n            if (request.tile.tileCoords.equals(request.tileCoords) == false) { //make sure tile still has same coords\n                console.warn(this.prettyName() + \"tile coords: \" + request.tileCoords + \" are no longer around, we must have already changed tile\");\n\n                this.removePendingRequest(rIndex);\n                return;\n            }\n\n            if (request.requestType == BuildingRequestType.LoadTile) {\n\n                this.handleLoadTileRequest(request);\n                return;\n            }\n\n            if (request.requestType == BuildingRequestType.CreateBuilding) {\n                this.removePendingRequest(rIndex);\n\n                if (request.feature !== undefined) {\n                    if (request.epsgType !== undefined) { //create building request must have a projectionType\n                        //console.log(\"generating single building for tile: \" + request.tileCoords);\n\n                        //TODO: passing too many parameters into this!\n                        //maybe allow it to reference this class instead?\n                        this.ourGeoJSON.generateSingleBuilding(this.name, request.feature, request.epsgType, request.tile, request.flipWinding, this);\n                    } else {\n                        console.error(this.prettyName() + \"can't create a building with no projection specified!\");\n                    }\n                } else {\n                    console.error(this.prettyName() + \"can't create a building with no feature data!\");\n                }\n\n                //if (this.buildingRequests.length > 0) { //take a peek at next upcoming request\n                //    if (this.buildingRequests[0].requestType != BuildingRequestType.CreateBuilding) { //if its not another building, end processing this frame\n                //        return;\n                //    }\n                //}\n            }\n\n            if (request.requestType == BuildingRequestType.MergeAllBuildingsOnTile) {\n                this.removePendingRequest(rIndex);\n\n                console.log(this.prettyName() + \"processing merge request for tile: \" + request.tileCoords);\n                //console.log(\"  number of buildings in merge: \" + request.tile.buildings.length);\n\n                if (request.tile.buildings.length > 1) {\n                    for (let b of request.tile.buildings) {\n                        if (b.mesh.isReady() == false) {\n                            console.error(this.prettyName() + \"ERROR: Mesh not ready!\");\n                        }\n                    }\n                    //console.log(\"about to do big merge\");\n                    const allMeshes: Mesh[] = request.tile.getAllBuildingMeshes();\n                    const merged = Mesh.MergeMeshes(allMeshes, false); //false=don't get rid of originals\n\n                    if (merged) {\n                        merged.setParent(request.tile.mesh);\n                        merged.name = \"all_buildings_merged\";\n\n                        request.tile.hideIndividualBuildings();\n\n                        request.tile.mergedBuildingMesh = merged;\n                    } else {\n                        console.error(this.prettyName() + \"ERROR: unable to merge meshes!\");\n                    }\n                } else {\n                    console.log(this.prettyName() + \"not enough meshes to merge: \" + request.tile.buildings.length);\n                }\n\n                return;\n            }\n        }\n    }\n\n    public generateBuildings() {\n        console.log(this.prettyName() + \"user would like to generate buildings for all tiles in tileset\");\n\n        if (this.retrievalType == RetrievalType.IndividualTiles) {\n            console.log(\"we are going to issue a seperate request for each tile\");\n            for (const t of this.tileSet.ourTiles) {\n                this.SubmitLoadTileRequest(t);\n                console.log(this.prettyName() + \"submitting geojson load request for tile: \" + t.tileCoords);\n            }\n        }\n        if (this.retrievalType == RetrievalType.AllData) {\n            console.log(\"lets see if we can get all data pulled down at once\");\n            this.SubmitLoadAllRequest();\n        }\n    }\n}\n\n"]}